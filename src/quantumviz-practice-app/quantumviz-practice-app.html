<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/warp10-quantumviz/warp10-geoquantumviz.html">
<link rel="import" href="../../bower_components/warp10-quantumviz/warp10-display-c3-chart.html">
<link rel="import" href="../../bower_components/warp10-iron/warp10-warpscript-caller.html">

<dom-module id="quantumviz-practice-app">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <warp10-display-chart
       data="{{data}}"
       debug
       tooltip></warp10-display-chart>
    <warp10-warpscript-caller
      auto
      debug
      url="{{_baseUrl}}"
      warpscript="{{ warpscriptScript }}"
      on-response="_handleResponse"
      on-error="_handleError"></warp10-warpscript-caller>
    <div style="height: 1024px">
      <warp10-geoquantumviz
        map-zoom="14"
        show-axis="false"
        tooltip="false"
        line-width="2"
        reload="0"
        host="{{_baseUrl}}">
        'ZZ63qGJSJ5gWc3QUIKbYXng_.mDHJjEJH.8XSygfHM7Bzle2UG9ljmzQpURlrcCuvlvAy1HUyLO3CieY6Aa_BwsNzFLZ5MYAniL6EQD.QUgpIycT7y9pz8rSjsV1GoTRZAX7XS1GNuOEINj6lpWY0f4IFjYaiF9S'
        'READ' STORE

        'POLYGON ((7.05 43.60, 7.02 43.62, 7.09 43.64, 7.11 43.62, 7.05 43.60))' 0.01 false GEO.WKT
        GEO.REGEXP '~(' SWAP + ')' +
        'regexp' STORE

        $READ AUTHENTICATE 1000000 MAXOPS

        [ $READ 'data.fuel' { 'type' 'gazole' 'loc' $regexp } NOW -1 ] FETCH 'data' STORE
        $data

        NOW ISO8601
        '2017-09-01T00:00:00.000000Z'
        TIMECLIP
        NONEMPTY

        [ SWAP
        <%
        // Extract lat + lon
        [ 3 7 ] SUBLIST FLATTEN DUP
        [ 1 2 ] SUBLIST LIST-> DROP
        43.620 7.057
        HAVERSINE 'dist' STORE
        <% $dist 10000.0 > %>
        <% NULL 4 SET %>
        IFT
        %> MACROMAPPER 0 0 0
        ] MAP NONEMPTY

        [ SWAP
        bucketizer.min
        0
        31536000000000
        0
        ] BUCKETIZE

        [ SWAP
        []
        reducer.min
        ] REDUCE
        [ SWAP mapper.tostring 0 0 0 ] MAP

        // Get station value and its metadata (Name of the station)
        LIST-> DROP [ SWAP LOCATIONS ] FLATTEN LIST-> DROP ->HHCODE 'hfilter' STORE
        [ $data [ ] { 'loc' $hfilter } filter.byattr ] FILTER
        [ SWAP mapper.tostring 0 0 0 ] MAP
        'gtsList' STORE
        { 'gts' $gtsList 'params' [ { 'render' 'marker' 'marker' 'fuel' } ] }
      </warp10-geoquantumviz>
    </div>
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class QuantumvizPracticeApp extends Polymer.Element {
      static get is() {
        return 'quantumviz-practice-app';
      }

      static get properties() {
        return {
          _baseUrl: {
            type: String,
            value: 'http://localhost:8080/api/v0/exec',
          },
          data: {
            type: Object,
            value: function () {
              return {};
            }
          }
        };
      }

      ready() {
        super.ready();
        this.warpscriptScript = `
        'ZZ63qGJSJ5gWc3QUIKbYXng_.mDHJjEJH.8XSygfHM7Bzle2UG9ljmzQpURlrcCuvlvAy1HUyLO3CieY6Aa_BwsNzFLZ5MYAniL6EQD.QUgpIycT7y9pz8rSjsV1GoTRZAX7XS1GNuOEINj6lpWY0f4IFjYaiF9S'
'READ' STORE

[ $READ 'data.fuel' { 'type' 'gazole' 'cp' '29470' } NOW 365 d ] FETCH

'gts' STORE
{
  'gts' $gts
  'params' [ { 'color'  '#FF9900' } { 'color' '#039be5' } ]
  'globalParams' { 'interpolate' 'area-spline' }
}
         `;
      }

      _handleResponse(event, response) {
        console.log('_handleResponse', response);
        this.data = response.stack;
        console.log('_handleResponse - parsed - dataChanged', this.data);
      }

      _handleError(event, error) {
        if (error.request.xhr.responseText.match(/<pre>\s*(.*)\s*<\/prse>/)) {
          this.errorMsg = error.request.xhr.responseText.match(/<pre>\s*(.*)\s*<\/prse>/)[1];
        } else {
          this.errorMsg = error.request.statusText;
        }
        console.log('_handleError', {error: error, errorMsg: this.errorMsg});
      }

      _stringify(o) {
        return JSON.stringify(o);
      }
    }

    window.customElements.define(QuantumvizPracticeApp.is, QuantumvizPracticeApp);
  </script>
</dom-module>